<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Geocode with OpenCage</title>
    <meta
      property="og:description"
      content="Geocode with Opencage and the maplibre-gl-geocoder plugin."
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1.0"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.5.0/dist/maplibre-gl-geocoder.css"
    />
    <script src="https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.5.0/dist/maplibre-gl-geocoder.min.js"></script>
    <script src="https://unpkg.com/opencage-api-client@2.0.0/dist/opencage-api.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      html,
      body,
      #map {
        height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <script>
      const map = new maplibregl.Map({
        container: 'map',
        style: `https://api.thunderforest.com/styles/atlas/style.json?apikey=THUNDERFOREST_API_KEY`, // Replace with your Thunderforest API key
        center: [-0.1275, 51.507222],
        zoom: 3,
        canvasContextAttributes: { antialias: true },
      });

      const geocoderApi = {
        forwardGeocode: async (config) => {
          const features = [];
          try {
            const response = await opencage.geocode({
              key: 'OPENCAGE_API_KEY', // Replace with your OpenCage API key
              q: config.query,
              limit: 5, // Limit results to 5
              no_annotations: 1, // Exclude annotations for simplicity
            });
            if (response.results && response.results.length > 0) {
              for (const result of response.results) {
                const center = [result.geometry.lng, result.geometry.lat];
                const point = {
                  type: 'Feature',
                  geometry: {
                    type: 'Point',
                    coordinates: center,
                  },
                  place_name: result.formatted,
                  properties: result.components,
                  text: result.formatted,
                  place_type: ['place'],
                  center,
                };
                features.push(point);
              }
            }
          } catch (e) {
            console.error(`Failed to forwardGeocode with error: ${e}`);
          }

          return {
            features,
          };
        },
      };
      map.addControl(
        new MaplibreGeocoder(geocoderApi, {
          maplibregl,
        })
      );
    </script>
  </body>
</html>
